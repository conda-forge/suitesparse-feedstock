From f6daae26ee391e475e2295e77c839aa7c1a8b784 Mon Sep 17 00:00:00 2001
From: Min RK <benjaminrk@gmail.com>
Date: Tue, 19 Nov 2019 10:07:27 +0100
Subject: [PATCH] set install_name to $(SO_MAIN) on mac

install_name is the mac equivalent of soname

ensures runtime compatibility of dependents compiled against the same SO version
---
 GraphBLAS/Tcov/Makefile                  | 2 +-
 GraphBLAS/alternative/Makefile           | 4 ++--
 SuiteSparse_config/SuiteSparse_config.mk | 1 +
 3 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/GraphBLAS/Tcov/Makefile b/GraphBLAS/Tcov/Makefile
index 7ed472c6..5a3dad29 100644
--- a/GraphBLAS/Tcov/Makefile
+++ b/GraphBLAS/Tcov/Makefile
@@ -35,7 +35,7 @@ ifeq ($(UNAME),Darwin)
     # Mac
     CFLAGS += -fno-common
     SO_NAME = libgraphblas_tcov.dylib
-    SO_OPTS += -dynamiclib -shared -undefined dynamic_lookup
+    SO_OPTS += -dynamiclib -shared -Wl,-install_name -Wl,$(SO_NAME) -undefined dynamic_lookup
 else
     # Linux
     SO_NAME = libgraphblas_tcov.so
diff --git a/GraphBLAS/alternative/Makefile b/GraphBLAS/alternative/Makefile
index 545edc89..a61a5e20 100644
--- a/GraphBLAS/alternative/Makefile
+++ b/GraphBLAS/alternative/Makefile
@@ -37,13 +37,13 @@ ifeq ($(UNAME),Darwin)
     SO_NAME = libgraphblas.dylib.$(VER1).$(VER2).$(VER3)
     SO_NAME0 = libgraphblas.dylib
     SO_NAME1 = libgraphblas.dylib.$(VER1)
-    SO_OPTS += -dynamiclib -shared -undefined dynamic_lookup
+    SO_OPTS += -dynamiclib -shared  -Wl,-install_name -Wl,$(SO_NAME1) -undefined dynamic_lookup
 else
     # Linux
     SO_NAME = libgraphblas.so.$(VER1).$(VER2).$(VER3)
     SO_NAME0 = libgraphblas.so
     SO_NAME1 = libgraphblas.so.$(VER1)
-    SO_OPTS += -shared -Wl,-soname -Wl,$(SO_NAME)
+    SO_OPTS += -shared -Wl,-soname -Wl,$(SO_NAME1)
 endif
 
 %.o: ../Source/%.c $(INC)
diff --git a/SuiteSparse_config/SuiteSparse_config.mk b/SuiteSparse_config/SuiteSparse_config.mk
index 58152235..0256e267 100644
--- a/SuiteSparse_config/SuiteSparse_config.mk
+++ b/SuiteSparse_config/SuiteSparse_config.mk
@@ -464,6 +464,7 @@ else
         SO_TARGET = $(LIBRARY).$(VERSION).dylib
         SO_OPTS  += -dynamiclib -compatibility_version $(SO_VERSION) \
                     -current_version $(VERSION) \
+                    -Wl,-install_name -Wl,$(SO_MAIN) \
                     -shared -undefined dynamic_lookup
         # When a Mac *.dylib file is moved, this command is required
         # to change its internal name to match its location in the filesystem:
